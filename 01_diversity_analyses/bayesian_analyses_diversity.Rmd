---
title: "Bayesian analyses for diversity"
output: 
---
## Libraries used in this code 
```{r}
library(tidyverse)
library(vcd) # used to get Cramer's V effect size on Fisher's exact test
library(rcompanion) # used to do pairwise Fisher's exact test
library(plyr) # used for rbind.fill()
```

## Strategies for selection

There are 6 proposed strategies that children and adults may be utilizing in the diversity task.

1. **Random Strategy:** In this strategy, participants choose randomly across the 4 available options regardless of the choice made by the experimenter. The only thing they don't do is choose the option that was selected by the experimenter. 
2. **Extreme Strategy:** In this strategy, the participant chooses the most extreme value on the scale available to select from. Thus, the participant chooses 5 unless 5 was already selected. If the latter is the case, the participant chooses 4. Currently, this strategy does not account for valence is written in the code. This is the strategy we expect children to use. 
3. **Diverse Strategy:** In this strategy, participants are adjusting their choice relative to the experimenter choice. Participants maximize distance between their choice and the experimenter's choice. This is one of the strategies we expect adults might be using. 
4. **Average Strategy:**: In this strategy, participants are trying to choose an option that, when averaged with the experimenter's choice, comes out to equal 3; that is, they are trying to make the selection space reflect the average of the choices. We expect adults may be utilizing this strategy, too. 
5. **Middle Strategy:** In this strategy, participants choose the middle option regardless of the experimenter's choice. In the instance that the middle has already been selected, they choose an option nearest to the middle. 
6. **Researcher-adjacent Strategy:**: In this strategy, participants choose an option that is adjacent to the experimenter's choice, either the option above or below. 

## Defining the hypothesis space 

This creates a matrix for each strategy (assigning probabilities to how a likely a choice would be if the person adopted a particular strategy). These individual matrices are compiled into a single matrix that has all possible selections given experimenter choice. This will be used to compare the participants' choices to. 
```{r}
random_matrix = as.data.frame(matrix(c(c(1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5),
                                       c(2,3,4,5,1,3,4,5,1,2,4,5,1,2,3,5,1,2,3,4),
                                       c(.25,.25,.25,.25,.25,.25,.25,.25,.25,.25,.25,.25,.25,.25,.25,.25,.25,.25,.25,.25),
                                       c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)), 
                              ncol = 4))
random_matrix$prob_strategy <- "random"

extreme_matrix = as.data.frame(matrix(c(c(1,1,2,2,3,3,4,4,5),
                                        c(5,4,5,4,5,4,5,4,4),
                                        c(.8,.2,.8,.2,.8,.2,.8,.2,1),
                                        c(2,2,2,2,2,2,2,2,3)), 
                              ncol = 4))
extreme_matrix$prob_strategy <- "extreme"

diverse_matrix = as.data.frame(matrix(c(c(1,1,2,2,3,3,4,4,5,5),
                                        c(5,4,5,4,1,5,1,2,1,2),
                                        c(.8,.2,.8,.2,.5,.5,.8,.2,.8,.2),
                                        c(2,2,2,2,2,2,2,2,2,2)), 
                              ncol = 4))
diverse_matrix$prob_strategy <- "diverse"

average_matrix = as.data.frame(matrix(c(c( 1, 1, 2, 2, 3, 3, 3, 3, 4, 4, 5, 5),
                                        c( 5, 4, 4, 5, 1, 2, 4, 5, 2, 1, 1, 2),
                                        c(.8,.2,.8,.2,.1,.4,.4,.1,.8,.2,.8,.2),
                                        c( 2, 2, 2, 2, 0, 0, 0, 0, 2, 2, 2, 2)), 
                              ncol = 4))
average_matrix$prob_strategy <- "average"

middle_matrix = as.data.frame(matrix(c(c(1,2,3,3,4,5),
                                       c(3,3,4,2,3,3),
                                       c(1,1,.5,.5,1,1),
                                       c(3,3,2,2,3,3)), 
                              ncol = 4))
middle_matrix$prob_strategy <- "middle"

adjacent_matrix = as.data.frame(matrix(c(c(1,2,2,3,3,4,4,5),
                                         c(2,1,3,2,4,3,5,4),
                                         c(1,.5,.5,.5,.5,.5,.5,1),
                                         c(3,2,2,2,2,2,2,3)), 
                              ncol = 4))
adjacent_matrix$prob_strategy <- "adjacent"

# Listing all data frames and changing their names
dfs <- c("diverse_matrix", "extreme_matrix", "random_matrix", "average_matrix", "middle_matrix", "adjacent_matrix")

for(df in dfs) {
  df_tmp <- get(df)
  colnames(df_tmp) <- c("exp_choice","agent_choice", "probability","number_of_unexpected_choices","prob_strategy")
  assign(df, df_tmp)
}

df_list <- list(diverse_matrix, extreme_matrix, random_matrix, average_matrix, middle_matrix, adjacent_matrix)
```


## Setting epsilon and adjusting probability values in accordance with epsilon

Episilon is the value that defines how often someone behaves randomly despite having an adopted strategy. Lower values of episilon means that the participant is assumed to perform less randomly, and higher values means that participant is assumed to make random decisions more frequently. 

Probabilities in the hypothesis space are adjusted for episilon. 

```{r}
# Parameter to determine how often agent behaves randomly
# Lower values mean agent behaves less randomly
epsilon <- .16

# updating hypothesis space based on epsilon value
# will be needed for computing likelihoods later
expected_matrix <- bind_rows(df_list)
expected_matrix$prob_strategy <- as.factor(expected_matrix$prob_strategy)
expected_matrix$probability <- ifelse(expected_matrix$probability == .25, expected_matrix$probability, 
                                      expected_matrix$probability - (epsilon/(4-expected_matrix$number_of_unexpected_choices))) 
expected_matrix$probability_of_unexpected <- ifelse(expected_matrix$number_of_unexpected_choices == 0, 0,
                                                    epsilon/expected_matrix$number_of_unexpected_choices)
```


## Reading in the behavioral data
```{r, include=FALSE}
# set where the data is located
behavioral_data <- read_csv("../../../../diversity/01_diversity_analyses/diversity_fulldataset_cleaned.csv") 

# specifying certain columns as numeric and remaning (participant's) response column to agent_choice
behavioral_data$exp_choice <- as.numeric(as.character(behavioral_data$exp_choice))
colnames(behavioral_data)[2] <- "agent_choice"
behavioral_data$agent_choice <- as.numeric(as.character(behavioral_data$agent_choice))

# assigning an agent_id separate from participant number. I did this because at one point I was having issues with a function because some IDs are numeric and others are not, and the function preferred numeric only.... 
i <- 0 
behavioral_data$agent_id <- 1
for (i in 2:nrow(behavioral_data)){
  if (behavioral_data$id[i] == behavioral_data$id[i-1] &&
      behavioral_data$condition[i] == behavioral_data$condition[i-1]){
    behavioral_data$agent_id[i] <- behavioral_data$agent_id[i-1]
  } else {
    behavioral_data$agent_id[i] <- behavioral_data$agent_id[i-1] + 1
  }
  i <- i + 1
}

# Separating diversity data into separate data frames for each age group
behavioral_data_adult <- behavioral_data %>% filter(age_factor == "adult" & condition == "diversity")
behavioral_data_56 <- behavioral_data %>% filter(age_factor == "5s/6s" & condition == "diversity")
behavioral_data_78 <- behavioral_data %>% filter(age_factor == "7s/8s" & condition == "diversity")
behavioral_data_910 <- behavioral_data %>% filter(age_factor == "9s/10s" & condition == "diversity")
```

## Defining a helper function

This function creates a data frame will all possible choices and probabilities associated with them, and matches it with participants' responses. This is used for computing likelihoods. 
```{r}

fill_in_probs <- function(df1, df2){
  a <- c("number_of_unexpected_choices", "probability_of_unexpected")
  # subsetting to have df with all strategies but random and then removing columns that will be added later
  temp1 <- subset(df1, prob_strategy != "random")
  temp1 <- temp1[,!(names(df1) %in% a)]
  # getting the columns removed from above from the main df that has all of them, so they can be merged back in
  temp2 <- subset(df2, prob_strategy != "random")
  temp2 <- temp2[, c(1,4:6)]
  # adding the columns back in so they are complete (no NA values)
  final <- unique(merge(temp1, temp2, by = c("exp_choice", "prob_strategy")))
  # now adding the random back in as well; had to treat random separately because they are unique strategy in terms
  # of number of possibilities
  temp3 <- subset(df1, prob_strategy == "random")
  final <- bind_rows(temp3, final)
  # filling in NAs for agent id and probabilities so template will be complete for computing likelihoods
  final$probability <- ifelse(is.na(final$probability), final$probability_of_unexpected, final$probability)
  final$agent_id <- final$agent_id[1]
  
  return(final)
}

```

## Computing likelihoods and posteriors for adult data
```{r, include=FALSE}
# template that is used to save probabilities of data (agent's selection) given a specific strategy 
probability_template <- expand.grid(prob_strategy = unique(expected_matrix$prob_strategy),
                                    exp_choice = unique(expected_matrix$exp_choice))

list_of_probabilities_adult_data = list()

# splitting adult data into individual data frames by id to be processed below
list_of_adult_data <- split(behavioral_data_adult, behavioral_data_adult$agent_id)

# computing probabilities of data (agent's selection) given a specific strategy 
# Separate data frame for each agent
# Saving all to a list 
for(i in 1:length(list_of_adult_data)){
  z <- inner_join(expected_matrix, list_of_adult_data[[i]])
  z <- merge(probability_template, z, all = TRUE)
  list_of_probabilities_adult_data[[i]] <- fill_in_probs(z, expected_matrix)
}

# combining list of probabilities into single data frame
probabilities_adult_data <- plyr::rbind.fill(list_of_probabilities_adult_data)

# list to store likelihood dfs
list_of_likelihoods_adult_data <- list()

# function to compute likelihood of each strategy by individual
calculate_ll <- function(df, strategy){
  a <- strategy
  b <- df %>% filter(agent_id == current_agent) %>% filter(prob_strategy == a) %>% summarize(likelihood = prod(probability), 
                                                                                strategy_ll = a)
  return(b)
}

i <- 0
for(iteration in 1:(as.numeric(nrow(probabilities_adult_data))/30)){
  # initializing likelihood df template
  likelihoods_adult_data <- as.data.frame(matrix(ncol = 3, nrow = 0))
  current_agent <- probabilities_adult_data$agent_id[iteration*30]
    for(i in 1:length(strategies)){
      # initializing likelihood df template
      y <- calculate_ll(probabilities_adult_data, strategies[i])
      y$agent_id <- probabilities_adult_data$agent_id[iteration*30]
      likelihoods_adult_data <- rbind(likelihoods_adult_data, y)
      i <- i + 1
    }
  likelihoods_adult_data$likelihoodXprior <- likelihoods_adult_data$likelihood / length(strategies)
  list_of_likelihoods_adult_data[[iteration]] <- likelihoods_adult_data
  i <- 0 
  iteration <- iteration + 1
}

likelihoods_adult_data <- plyr::rbind.fill(list_of_likelihoods_adult_data)

# computing the sum of likelihoods (the denominator in Bayes' Rule)
sum_ll <- likelihoods_adult_data %>% group_by(agent_id) %>% dplyr::summarise(sum_ll = sum(likelihoodXprior))
likelihoods_adult_data <- merge(sum_ll, likelihoods_adult_data, by = "agent_id")    

# computing the posterior probabilities 
# aka probability that agent was using a given strategy given the data observed
likelihoods_adult_data$posterior <- likelihoods_adult_data$likelihoodXprior / likelihoods_adult_data$sum_ll
```

## Plots displaying most used strategies
```{r}
# ranking strategies based on posteriors
likelihoods_adult_data %<>% dplyr::group_by(agent_id) %>%
  dplyr::mutate(strategy_rank = rank(desc(posterior))) %>%
  dplyr::arrange(strategy_rank)

# converting columns to factors
likelihoods_adult_data$strategy_rank <- as.factor(likelihoods_adult_data$strategy_rank)
likelihoods_adult_data$agent_id <- as.factor(likelihoods_adult_data$agent_id)

# creating dataframe with top used strategies
top_strategies_adult <- subset(likelihoods_adult_data, strategy_rank == c("1"))

# creating dataframe with mean posteriors for each stategy for adults
means_adults <- likelihoods_adult_data %>% group_by(strategy_ll) %>% summarize(m_adult = mean(posterior))

# several plot options 
plot16 <- ggplot() + 
  # geom_line(data = likelihoods_adult_data, aes(x = strategy_ll, y = posterior, group = agent_id, color = agent_id), linetype = 2) +
  geom_point(data = likelihoods_adult_data, aes(x = strategy_ll, y = posterior),
             position = position_jitter(w = 0.1, h = 0),
             shape = 1,
             size = 2) +
  # geom_line() +
  # coord_cartesian(ylim=c(0,1)) +
  geom_line(data = likelihoods_adult_data,
            aes(x = strategy_ll, y = posterior, group = agent_id),
            position=position_dodge(width=0.2)) +
  geom_line(data = means_adults, aes(x = strategy_ll, y = m_adult), group = 1,
          size = 3) +
  theme_classic()
plot16

plot15 <- ggplot() +
    geom_density(data = top_strategies, aes(x = strategy_ll)) +
  theme_classic()
plot15

plot17 <- ggplot(data = likelihoods_adult_data) + 
  # facet_wrap(
  #    ~ agent_id
  # ) + 
  geom_line(aes(x = strategy_ll, y = posterior, color = agent_id), group = 1) +
  theme_classic()
plot17

```

## Computing likelihoods and posteriors for 5s/6s data
```{r, include=FALSE}
# template that is used to save probabilities of data (agent's selection) given a specific strategy 
probability_template <- expand.grid(prob_strategy = unique(expected_matrix$prob_strategy),
                                    exp_choice = unique(expected_matrix$exp_choice))

list_of_probabilities_56_data = list()

# splitting 56 data into individual data frames by id to be processed below
list_of_56_data <- split(behavioral_data_56, behavioral_data_56$agent_id)

# computing probabilities of data (agent's selection) given a specific strategy 
# Separate data frame for each agent
# Saving all to a list 
for(i in 1:length(list_of_56_data)){
  z <- inner_join(expected_matrix, list_of_56_data[[i]])
  z <- merge(probability_template, z, all = TRUE)
  list_of_probabilities_56_data[[i]] <- fill_in_probs(z, expected_matrix)
}

probabilities_56_data <- plyr::rbind.fill(list_of_probabilities_56_data)

# list to store likelihood dfs
list_of_likelihoods_56_data <- list()

# function to compute likelihood of each strategy by individual
calculate_ll <- function(df, strategy){
  a <- strategy
  b <- df %>% filter(agent_id == current_agent) %>% filter(prob_strategy == a) %>% summarize(likelihood = prod(probability), 
                                                                                strategy_ll = a)
  return(b)
}

i <- 0
for(iteration in 1:(as.numeric(nrow(probabilities_56_data))/30)){
  # initializing likelihood df template
  likelihoods_56_data <- as.data.frame(matrix(ncol = 3, nrow = 0))
  current_agent <- probabilities_56_data$agent_id[iteration*30]
    for(i in 1:length(strategies)){
      # initializing likelihood df template
      y <- calculate_ll(probabilities_56_data, strategies[i])
      y$agent_id <- probabilities_56_data$agent_id[iteration*30]
      likelihoods_56_data <- rbind(likelihoods_56_data, y)
      i <- i + 1
    }
  likelihoods_56_data$likelihoodXprior <- likelihoods_56_data$likelihood / length(strategies)
  list_of_likelihoods_56_data[[iteration]] <- likelihoods_56_data
  i <- 0 
  iteration <- iteration + 1
}

likelihoods_56_data <- plyr::rbind.fill(list_of_likelihoods_56_data)

# computing the sum of likelihoods (the denominator in Bayes' Rule)
sum_ll <- likelihoods_56_data %>% group_by(agent_id) %>% dplyr::summarise(sum_ll = sum(likelihoodXprior))
likelihoods_56_data <- merge(sum_ll, likelihoods_56_data, by = "agent_id")    

# computing the posterior probabilities 
# aka probability that agent was using a given strategy given the data observed
likelihoods_56_data$posterior <- likelihoods_56_data$likelihoodXprior / likelihoods_56_data$sum_ll

```

## Plotting options for 5s/6s
```{r}
# ranking strategies based on posteriors
likelihoods_56_data %<>% dplyr::group_by(agent_id) %>%
  dplyr::mutate(strategy_rank = rank(desc(posterior))) %>%
  dplyr::arrange(strategy_rank)

likelihoods_56_data$strategy_rank <- as.factor(likelihoods_56_data$strategy_rank)
likelihoods_56_data$agent_id <- as.factor(likelihoods_56_data$agent_id)

top_strategies56 <- subset(likelihoods_56_data, strategy_rank == c("1"))
means_56 <- likelihoods_56_data %>% group_by(strategy_ll) %>% summarize(m_56 = mean(posterior))

plot56 <- ggplot() + 
  # geom_line(data = likelihoods_56_data, aes(x = strategy_ll, y = posterior, group = agent_id, color = agent_id), linetype = 2) +
  geom_point(data = likelihoods_56_data, aes(x = strategy_ll, y = posterior),
             position = position_jitter(w = 0.1, h = 0),
             shape = 1,
             size = 2) +
  # geom_line() +
  # coord_cartesian(ylim=c(0,1)) +
  geom_line(data = likelihoods_56_data,
            aes(x = strategy_ll, y = posterior, group = agent_id),
            position=position_dodge(width=0.2)) +
  geom_line(data = means_56, aes(x = strategy_ll, y = m_56), group = 1,
          size = 3) +
  theme_classic()
plot56
```

## Analyzing 7s and 8s
```{r}
# template that is used to save probabilities of data (agent's selection) given a specific strategy 
probability_template <- expand.grid(prob_strategy = unique(expected_matrix$prob_strategy),
                                    exp_choice = unique(expected_matrix$exp_choice))

list_of_probabilities_78_data = list()

# splitting 78 data into individual data frames by id to be processed below
list_of_78_data <- split(behavioral_data_78, behavioral_data_78$agent_id)

# computing probabilities of data (agent's selection) given a specific strategy 
# Separate data frame for each agent
# Saving all to a list 
for(i in 1:length(list_of_78_data)){
  z <- inner_join(expected_matrix, list_of_78_data[[i]])
  z <- merge(probability_template, z, all = TRUE)
  list_of_probabilities_78_data[[i]] <- fill_in_probs(z, expected_matrix)
}

probabilities_78_data <- plyr::rbind.fill(list_of_probabilities_78_data)

# list to store likelihood dfs
list_of_likelihoods_78_data <- list()


# function to compute likelihood of each strategy by individual
calculate_ll <- function(df, strategy){
  a <- strategy
  b <- df %>% filter(agent_id == current_agent) %>% filter(prob_strategy == a) %>% summarize(likelihood = prod(probability), 
                                                                                strategy_ll = a)
  return(b)
}

i <- 0
for(iteration in 1:(as.numeric(nrow(probabilities_78_data))/30)){
  # initializing likelihood df template
  likelihoods_78_data <- as.data.frame(matrix(ncol = 3, nrow = 0))
  current_agent <- probabilities_78_data$agent_id[iteration*30]
    for(i in 1:length(strategies)){
      # initializing likelihood df template
      y <- calculate_ll(probabilities_78_data, strategies[i])
      y$agent_id <- probabilities_78_data$agent_id[iteration*30]
      likelihoods_78_data <- rbind(likelihoods_78_data, y)
      i <- i + 1
    }
  likelihoods_78_data$likelihoodXprior <- likelihoods_78_data$likelihood / length(strategies)
  list_of_likelihoods_78_data[[iteration]] <- likelihoods_78_data
  i <- 0 
  iteration <- iteration + 1
}

likelihoods_78_data <- plyr::rbind.fill(list_of_likelihoods_78_data)

# computing the sum of likelihoods (the denominator in Bayes' Rule)
sum_ll <- likelihoods_78_data %>% group_by(agent_id) %>% dplyr::summarise(sum_ll = sum(likelihoodXprior))
likelihoods_78_data <- merge(sum_ll, likelihoods_78_data, by = "agent_id")    

# computing the posterior probabilities 
# aka probability that agent was using a given strategy given the data observed
likelihoods_78_data$posterior <- likelihoods_78_data$likelihoodXprior / likelihoods_78_data$sum_ll

```


## Plot options for 7/8s 
```{r}
# ranking strategies based on posteriors
likelihoods_78_data %<>% dplyr::group_by(agent_id) %>%
  dplyr::mutate(strategy_rank = rank(desc(posterior))) %>%
  dplyr::arrange(strategy_rank)

likelihoods_78_data$strategy_rank <- as.factor(likelihoods_78_data$strategy_rank)
likelihoods_78_data$agent_id <- as.factor(likelihoods_78_data$agent_id)

top_strategies78 <- subset(likelihoods_78_data, strategy_rank == c("1"))
means_78 <- likelihoods_78_data %>% group_by(strategy_ll) %>% summarize(m_78 = mean(posterior))

plot78 <- ggplot() + 
  # geom_line(data = likelihoods_78_data, aes(x = strategy_ll, y = posterior, group = agent_id, color = agent_id), linetype = 2) +
  geom_point(data = likelihoods_78_data, aes(x = strategy_ll, y = posterior),
             position = position_jitter(w = 0.1, h = 0),
             shape = 1,
             size = 2) +
  # geom_line() +
  # coord_cartesian(ylim=c(0,1)) +
  geom_line(data = likelihoods_78_data,
            aes(x = strategy_ll, y = posterior, group = agent_id),
            position=position_dodge(width=0.2)) +
  geom_line(data = means_78, aes(x = strategy_ll, y = m_78), group = 1,
          size = 3) +
  theme_classic()
plot78
```

## Analyzing 9s and 10s
```{r}
# template that is used to save probabilities of data (agent's selection) given a specific strategy 
probability_template <- expand.grid(prob_strategy = unique(expected_matrix$prob_strategy),
                                    exp_choice = unique(expected_matrix$exp_choice))

list_of_probabilities_910_data = list()

# splitting 910 data into individual data frames by id to be processed below
list_of_910_data <- split(behavioral_data_910, behavioral_data_910$agent_id)

# computing probabilities of data (agent's selection) given a specific strategy 
# Separate data frame for each agent
# Saving all to a list 
for(i in 1:length(list_of_910_data)){
  z <- inner_join(expected_matrix, list_of_910_data[[i]])
  z <- merge(probability_template, z, all = TRUE)
  list_of_probabilities_910_data[[i]] <- fill_in_probs(z, expected_matrix)
}

probabilities_910_data <- plyr::rbind.fill(list_of_probabilities_910_data)

# list to store likelihood dfs
list_of_likelihoods_910_data <- list()


# function to compute likelihood of each strategy by individual
calculate_ll <- function(df, strategy){
  a <- strategy
  b <- df %>% filter(agent_id == current_agent) %>% filter(prob_strategy == a) %>% summarize(likelihood = prod(probability), 
                                                                                strategy_ll = a)
  return(b)
}

i <- 0
for(iteration in 1:(as.numeric(nrow(probabilities_910_data))/30)){
  # initializing likelihood df template
  likelihoods_910_data <- as.data.frame(matrix(ncol = 3, nrow = 0))
  current_agent <- probabilities_910_data$agent_id[iteration*30]
    for(i in 1:length(strategies)){
      # initializing likelihood df template
      y <- calculate_ll(probabilities_910_data, strategies[i])
      y$agent_id <- probabilities_910_data$agent_id[iteration*30]
      likelihoods_910_data <- rbind(likelihoods_910_data, y)
      i <- i + 1
    }
  likelihoods_910_data$likelihoodXprior <- likelihoods_910_data$likelihood / length(strategies)
  list_of_likelihoods_910_data[[iteration]] <- likelihoods_910_data
  i <- 0 
  iteration <- iteration + 1
}

likelihoods_910_data <- plyr::rbind.fill(list_of_likelihoods_910_data)

# computing the sum of likelihoods (the denominator in Bayes' Rule)
sum_ll <- likelihoods_910_data %>% group_by(agent_id) %>% dplyr::summarise(sum_ll = sum(likelihoodXprior))
likelihoods_910_data <- merge(sum_ll, likelihoods_910_data, by = "agent_id")    

# computing the posterior probabilities 
# aka probability that agent was using a given strategy given the data observed
likelihoods_910_data$posterior <- likelihoods_910_data$likelihoodXprior / likelihoods_910_data$sum_ll

```

## Plot options for 9s and 10s 

```{r}
# ranking strategies based on posteriors
likelihoods_910_data %<>% dplyr::group_by(agent_id) %>%
  dplyr::mutate(strategy_rank = rank(desc(posterior))) %>%
  dplyr::arrange(strategy_rank)

likelihoods_910_data$strategy_rank <- as.factor(likelihoods_910_data$strategy_rank)
likelihoods_910_data$agent_id <- as.factor(likelihoods_910_data$agent_id)

top_strategies910 <- subset(likelihoods_910_data, strategy_rank == c("1"))
means_910 <- likelihoods_910_data %>% 
  group_by(strategy_ll) %>% 
  filter(!is.na(posterior)) %>% 
  summarize(m_910 = mean(posterior))

plot910 <- ggplot() + 
  # geom_line(data = likelihoods_910_data, aes(x = strategy_ll, y = posterior, group = agent_id, color = agent_id), linetype = 2) +
  geom_point(data = likelihoods_910_data, aes(x = strategy_ll, y = posterior),
             position = position_jitter(w = 0.1, h = 0),
             shape = 1,
             size = 2) +
  # geom_line() +
  # coord_cartesian(ylim=c(0,1)) +
  geom_line(data = likelihoods_910_data,
            aes(x = strategy_ll, y = posterior, group = agent_id),
            position=position_dodge(width=0.2)) +
  geom_line(data = means_910, aes(x = strategy_ll, y = m_910), group = 1,
          size = 3) +
  theme_classic()
plot910
```

## Plot of top strategy data

```{r}
# Combining top strategy data frames from all age groups into one df
top_strategies <- rbind(top_strategies_adult, top_strategies56, top_strategies78, top_strategies910)
top_strategies$agent_id <- as.numeric(top_strategies$agent_id)

# Pulling age data in top strategy df
ages <- behavioral_data %>% 
  select(agent_id, age_exact, age_factor) %>% 
  filter(!duplicated(agent_id)) 

top_strategies <- full_join(top_strategies, ages)

# Assining adults exact age of 12 since we are interested in adults as a group
top_strategies <- top_strategies %>% 
  filter(!is.na(sum_ll)) 

top_strategies$age_exact <- ifelse(top_strategies$age_factor == "adult", 12, top_strategies$age_exact)

# Plot options 
plot_top <- ggplot(data = top_strategies) +
  geom_point(aes(x = age_exact, y = strategy_ll),
             position = position_jitter(h = 0.2),
             alpha = .5) +
  theme_classic()
plot_top

plot_top1 <- ggplot(data = top_strategies, aes(x = strategy_ll, y = age_exact)) +
  geom_violin(trim = FALSE, scale = "count") +
  geom_point(position = position_jitter(w = 0.2)) +
  scale_y_continuous(limits = c(4.9, 12.1)) +
  coord_flip() +
  theme_classic()
plot_top1

```


## Running Fisher's exact test to compare frequencies of strategy use across age groups
```{r}

chisq_table <- table(top_strategies$age_factor, top_strategies$strategy_ll)

fisher.test(table(top_strategies$age_factor, top_strategies$strategy_ll), workspace = 2e8)

# to get effect size (Cramer's V) (uses 'vcd' package)
vcd::assocstats(chisq_table)

# pairwise Fisher's exact comparing age groups; Using Holm's method for p adjust
# function from 'rcompanion' package
rcompanion::pairwiseNominalIndependence(chisq_table,
                                          fisher = TRUE,
                                          gtest  = FALSE,
                                          chisq  = FALSE,
                                          method = "holm")

# This table can be used to analyze pairwise of stategies (above is pairwise of age)
chisq_table_rev <- table(top_strategies$strategy_ll, top_strategies$age_factor)

# These tables can be used to analyze just pairwise of average, diverse, and extreme either across all four age groups (first table: chisq_table_3_allages) or a collapsed dichotomy comparing younger kids (5 - 8) to older kids (9-10) and adults (second table: chisq_table_3_agedich)
chisq_table_3 <- top_strategies %>% 
  filter(strategy_ll == "diverse" | strategy_ll == "average" | strategy_ll == "extreme")

chisq_table_3$age_di <- ifelse(chisq_table_3$age_factor == "9s/10s" | chisq_table_3$age_factor == "adult", "old", "young")

chisq_table_3_allages <- table(chisq_table_3$strategy_ll, chisq_table_3$age_factor)
chisq_table_3_agedich <- table(chisq_table_3$strategy_ll, chisq_table_3$age_di)
```

